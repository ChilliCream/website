<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Building a real-time .NET GraphQL Client API · ChilliCream</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="We are busy, busy, busy working on version 11 of _Hot Chocolate_ and _Strawberry Shake_."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Building a real-time .NET GraphQL Client API · ChilliCream"/><meta property="og:type" content="website"/><meta property="og:url" content="https://chillicream.com/blog/2019/11/25/strawberry-shake_2"/><meta property="og:description" content="We are busy, busy, busy working on version 11 of _Hot Chocolate_ and _Strawberry Shake_."/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://chillicream.com/img/signet.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css"/><link rel="alternate" type="application/atom+xml" href="https://chillicream.com/blog/atom.xml" title="ChilliCream Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://chillicream.com/blog/feed.xml" title="ChilliCream Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-72800164-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:700,400"/><link rel="stylesheet" href="/css/code-block-buttons.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/google-adsense.js"></script><script type="text/javascript" src="/js/disqus.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/signet.png" alt="ChilliCream"/><h2 class="headerTitleWithLogo">ChilliCream</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="https://shop.chillicream.com" target="_blank">Shop</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>All blog posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">All blog posts</h3><ul class=""><li class="navListItem"><a class="navItem" href="/blog/2019/12/26/hotchocolate-10.3.0">GraphQL - Hot Chocolate 10.3.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/11/29/schema-design">Lets supercharge your GraphQL schema :)</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/blog/2019/11/25/strawberry-shake_2">Building a real-time .NET GraphQL Client API</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/09/27/strawberry-shake">Building a .NET GraphQL Client API</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/08/14/hot-chocolate-10.0.0">GraphQL - Hot Chocolate 10.0.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/06/05/hot-chocolate-9.0.0">GraphQL - Hot Chocolate 9.0.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/05/08/performance">GraphQL - Hot Chocolate 9.0.0 - Performance Improvements</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/04/12/type-system">GraphQL - Hot Chocolate 9.0.0 - Type System</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/04/11/integration-tests">GraphQL - How to write integration tests against Hot Chocolate</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/03/31/hot-chocolate-0.8.1">GraphQL - Hot Chocolate 0.8.1</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/03/19/logging-with-hotchocolate">GraphQL - Tracing with Hot Chocolate</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/03/04/hot-chocolate-0.8.0">GraphQL - Hot Chocolate 0.8.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/02/20/schema-stitching">GraphQL - Schema Stitching with Version 8</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/02/04/instrumentation-and-apollo-tracing">GraphQL .NET Instrumentation API and Apollo Tracing</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/02/04/hot-chocolate-0.7.0">GraphQL - Hot Chocolate 0.7.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/01/24/schema-stitching">GraphQL - Schema Stitching</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/11/07/docusaurus-docs-redirect">Docusaurus - How to redirect requests to /docs to a default url instead of getting a 404 error</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/09/02/hot-chocolate-0.4.5">GraphQL - Hot Chocolate 0.4.5</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/07/31/hot-chocolate-0.4.0">GraphQL - Hot Chocolate 0.4.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/07/30/green-donut-0.2.0">Green Donut 0.2.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/05/03/react-rasta-1.0.0">React Rasta 1.0.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2013/09/12/jquery-steps-form-wizard">How to create a Form Wizard using jQuery Steps</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog/2019/11/25/strawberry-shake_2">Building a real-time .NET GraphQL Client API</a></h1><p class="post-meta">November 25, 2019</p><div class="authorBlock"><p class="post-authorName"><a href="https://github.com/michaelstaib" target="_blank" rel="noreferrer noopener">Michael Staib</a></p><div class="authorPhoto"><a href="https://github.com/michaelstaib" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/9714350?s=100&amp;v=4" alt="Michael Staib"/></a></div></div></header><div><span><p><img src="/img/blog/strawberry-shake-banner.svg" alt="Strawberry Shake"></p>
<p>We are busy, busy, busy working on version 11 of <em>Hot Chocolate</em> and <em>Strawberry Shake</em>.</p>
<p>In this post I want to explore the client side of GraphQL on .NET more with a special emphasis on subscriptions.</p>
<p>Since, with the new version of <em>Strawberry Shake</em> our initial blog has become kind of invalid I also will walk you trough the basics again before heading into subscriptions and what lies beyond.</p>
<!--truncate-->
<h2><a class="anchor" aria-hidden="true" id="getting-started"></a><a href="#getting-started" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting Started</h2>
<p>Let us have a look at how we want to tackle things with <em>Strawberry Shake</em>. For this little walkthrough I will use our <a href="https://github.com/ChilliCream/hotchocolate/tree/master/examples/AspNetCore.StarWars"><em>Star Wars</em> server example</a>.</p>
<p>If you want to follow along then install the <a href="https://dotnet.microsoft.com/download/dotnet-core/3.0">.NET Core 3 SDK</a> . We are also supporting other .NET variants but for this example you will need the .NET Core 3 SDK.</p>
<p>Before we can start let us clone the <em>Hot Chocolate</em> repository and start our <em>Star Wars</em> server.</p>
<pre><code class="hljs css language-bash"><span class="token function">git</span> clone https://github.com/ChilliCream/hotchocolate.git
<span class="token builtin class-name">cd</span> hotchocolate
dotnet run --project examples/AspNetCore.StarWars/
</code></pre>
<p>Now that we have our <em>Star Wars</em> server running, lets create a folder for our client and install the <em>Strawberry Shake</em> CLI tools.
The <em>Strawberry Shake</em> CLI tools are optional but make initializing the client project much easier.</p>
<pre><code class="hljs css language-bash"><span class="token function">mkdir</span> berry
dotnet new tool-manifest
dotnet tool <span class="token function">install</span> StrawberryShake.Tools --version <span class="token number">11.0</span>.0-preview.58 --local
</code></pre>
<p>In our example we are using the new .NET CLI local tools. <code>dotnet new tool-manifest</code> creates the tools manifest which basically is like a packages.config and holds the information of which tools in which version we are using in our directory.</p>
<p>This is the great thing about local tools if you think about it, you can install tools to your repository and have always the right set of tools available to you in the moment you clone that repository.</p>
<p>The next command <code>dotnet tool install StrawberryShake.Tools --version 11.0.0-preview.58 --local</code> installs our <em>Strawberry Shake</em> tools. Once we have a final release of <em>Strawberry Shake</em> you do not need to speciefy the version anymore.</p>
<p>Next we need a little project. Let’s create a new console application so that we can easily run and debug what we are doing.</p>
<pre><code class="hljs css language-bash">dotnet new console -n BerryClient
<span class="token builtin class-name">cd</span> BerryClient
dotnet <span class="token function">add</span> package StrawberryShake --version <span class="token number">11.0</span>.0-preview.58
dotnet <span class="token function">add</span> package Microsoft.Extensions.Http --version <span class="token number">3.0</span>.0
dotnet <span class="token function">add</span> package Microsoft.Extensions.DependencyInjection --version <span class="token number">3.0</span>.0
</code></pre>
<p>OK, now that we have a project setup lets initialize the project by creating a local schema. Like with <em>Relay</em> we are holding a local schema file that can be extended with local types and fields. Our <em>GraphQL</em> compiler will use this schema information to validate the queries we write. This makes <em>GraphQL</em> query documents a part of the compilation process and with that a first-class citizen of our C# library.</p>
<blockquote>
<p>For the next step ensure that the <em>Star Wars</em> <em>GraphQL</em> server is running since we will fetch the schema from the server.</p>
</blockquote>
<blockquote>
<p>If you want to check out what commands are available with the tools just run <code>dotnet graphql</code> and the CLI tools will output the available commands.</p>
</blockquote>
<pre><code class="hljs css language-bash">dotnet graphql init http://localhost:5000/graphql -n StarWars -p ./StarWars
</code></pre>
<p>The init command will download the schema as GraphQL SDL and create a config to re-fetch the schema. Also, the config contains the client name. The client name defines how the client class and interface shall be named.</p>
<blockquote>
<p>Note: You can pass in the token and scheme if your endpoint is authenticated. There is also an update command to update the local schema.</p>
</blockquote>
<p>The configuration will look like the following:</p>
<pre><code class="hljs css language-json"><span class="token punctuation">{</span>
  <span class="token property">"Schemas"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"StarWars"</span><span class="token punctuation">,</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
      <span class="token property">"File"</span><span class="token operator">:</span> <span class="token string">"StarWars.graphql"</span><span class="token punctuation">,</span>
      <span class="token property">"Url"</span><span class="token operator">:</span> <span class="token string">"http://localhost:5000/graphql"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"ClientName"</span><span class="token operator">:</span> <span class="token string">"StarWarsClient"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>OK, now let’s get started by creating our first client API. For this open your editor of choice. I can recommend using <em>VSCode</em> for this at the moment since you will get GraphQL highlighting. As we move forward, we will refine the tooling and provide proper IntelliSense.</p>
<p>Now let us create a new file in our <code>StarWars</code> folder called <code>Queries.graphql</code> and add the following query:</p>
<blockquote>
<p>The file does not necessarily have to be called queries. You can call it however you want. The GraphQL compiler will figure out what files contain queries and what files contain schema definitions.</p>
</blockquote>
<pre><code class="hljs css language-graphql"><span class="token keyword">query</span> getFoo <span class="token punctuation">{</span>
  foo
<span class="token punctuation">}</span>
</code></pre>
<p>Now build your project.</p>
<pre><code class="hljs css language-bash">dotnet build
</code></pre>
<p>When we now compile, we get an <em>MSBuild</em> error on which we can click in <em>VSCode</em> and we are pointed to the place in our query file from which the error stems from. The error tells us that there is no field <code>foo</code> on the <code>Query</code> type.</p>
<pre><code class="hljs css language-bash">/Users/michael/Local/play/berry/BerryClient/StarWars/Queries.graphql<span class="token punctuation">(</span><span class="token number">2,3</span><span class="token punctuation">)</span>: error GQL: The field <span class="token variable"><span class="token variable">`</span>foo<span class="token variable">`</span></span> does not exist on the <span class="token builtin class-name">type</span> <span class="token variable"><span class="token variable">`</span>Query<span class="token variable">`</span></span><span class="token builtin class-name">.</span> <span class="token punctuation">[</span>/Users/michael/Local/play/berry/BerryClient/BerryClient.csproj<span class="token punctuation">]</span>
</code></pre>
<p>Your GraphQL query document is not just a string, it properly compiles and is fully typed. Let's change our query and compile again:</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">query</span> getFoo <span class="token punctuation">{</span>
  hero <span class="token punctuation">{</span>
    name
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="hljs css language-bash">dotnet build
</code></pre>
<p>Now our project changes and we get a new <code>Generated</code> folder that has all the types that we need to communicate with our backend.</p>
<p>Let us have a closer look at our client interface for a minute.</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IStarWarsClient</span>
<span class="token punctuation">{</span>
    Task<span class="token operator">&lt;</span>IOperationResult<span class="token operator">&lt;</span>IGetFoo<span class="token operator">>></span> <span class="token function">GetFooAsync</span><span class="token punctuation">(</span>
        <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The named operation <code>getFoo</code> has become the method <code>GetFooAsync</code> in our generated client. This is nice since we kind of control from our GraphQL document the shape of our C# API. But there is more to that. A query document can hold multiple named operations. In essence the query document describes the interface between the client and the server.</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">query</span> function_a <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">query</span> function_b <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">query</span> function_c <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Since, with GraphQL you essentially design your own service API by writing a query document you want to have control over the structure of your generated types. <em>Strawberry Shake</em> uses fragments to help you describe clean and reusable code components.</p>
<p>Let us redesign our query with fragments and make it a bit more complex.</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">query</span> getHero <span class="token punctuation">{</span>
  hero <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token fragment function">SomeDroid</span>
    <span class="token operator">...</span><span class="token fragment function">SomeHuman</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">SomeHuman</span> <span class="token keyword">on</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token fragment function">HasName</span>
  homePlanet
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">SomeDroid</span> <span class="token keyword">on</span> <span class="token class-name">Droid</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token fragment function">HasName</span>
  primaryFunction
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">HasName</span> <span class="token keyword">on</span> <span class="token class-name">Character</span> <span class="token punctuation">{</span>
  name
<span class="token punctuation">}</span>
</code></pre>
<p>The fragments will yield in the following type structure:</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISomeHuman</span>
    <span class="token punctuation">:</span> <span class="token class-name">IHasName</span>
<span class="token punctuation">{</span>
    <span class="token keyword">string</span> HomePlanet <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISomeDroid</span>
    <span class="token punctuation">:</span> <span class="token class-name">IHasName</span>
<span class="token punctuation">{</span>
    <span class="token keyword">string</span> PrimaryFunction <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IHasName</span>
<span class="token punctuation">{</span>
    <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Let us reflect on that, fragments not only let us re-use type selections in our query document but also let us create and mold our C# API into a clean type structure. This puts us as the consumer of <em>Strawberry Shake</em> in the driver seat.</p>
<p><strong>We</strong> decide what data we <strong>need</strong> and how they are <strong>shaped</strong>.</p>
<blockquote>
<p>We are currently looking into how we can aggregate data and flatten the type structure. We initially thought about introducing some directives to flatten the type structure. But as we thought further on that and we really felt we want to have something like <a href="https://github.com/APIs-guru/graphql-lodash">lodash</a>. We are still discussing on what we want to do here. So stay tuned.</p>
</blockquote>
<p>Let's make one more tweak to our query and then we get this example running.</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">query</span> getHero<span class="token punctuation">(</span><span class="token variable">$episode</span><span class="token punctuation">:</span> Episode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hero<span class="token punctuation">(</span><span class="token attr-name">episode</span><span class="token punctuation">:</span> <span class="token variable">$episode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token fragment function">SomeDroid</span>
    <span class="token operator">...</span><span class="token fragment function">SomeHuman</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">SomeHuman</span> <span class="token keyword">on</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token fragment function">HasName</span>
  homePlanet
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">SomeDroid</span> <span class="token keyword">on</span> <span class="token class-name">Droid</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token fragment function">HasName</span>
  primaryFunction
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">HasName</span> <span class="token keyword">on</span> <span class="token class-name">Character</span> <span class="token punctuation">{</span>
  name
<span class="token punctuation">}</span>
</code></pre>
<p>By defining a variable with our operation we now can pass in arguments. This makes our operation re-usable and a good interface with the server. GraphQL servers can pre-compile and optimize those parametrized query documents.</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IStarWarsClient</span>
<span class="token punctuation">{</span>
    Task<span class="token operator">&lt;</span>IOperationResult<span class="token operator">&lt;</span>IGetHero<span class="token operator">>></span> <span class="token function">GetHeroAsync</span><span class="token punctuation">(</span>
        Optional<span class="token operator">&lt;</span>Episode<span class="token operator">></span> episode <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">,</span>
        <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>OK, let's get it running and then go into more details.</p>
<p>By default the generator will also generate dependency injection code for <code>Microsoft.Extensions.DependencyInjection</code>.</p>
<p>In order to get our client up and running we just have to set up a dependency injection container.</p>
<blockquote>
<p>Note: You can shut off dependency injection generation with a <em>MSBuild</em> property. The client can also be instantiated with a builder or by using a different dependency injection container.</p>
</blockquote>
<p>Replace your <code>Program</code> class with the following code.</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> serviceCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceCollection<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span>
            <span class="token string">"StarWarsClient"</span><span class="token punctuation">,</span>
            c <span class="token operator">=></span> c<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"http://localhost:5000/graphql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceCollection<span class="token punctuation">.</span><span class="token function">AddStarWarsClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IServiceProvider</span> services <span class="token operator">=</span> serviceCollection<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IStarWarsClient</span> client <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">IStarWarsClient</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        IOperationResult<span class="token operator">&lt;</span>IGetHero<span class="token operator">></span> result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetHeroAsync</span><span class="token punctuation">(</span>Episode<span class="token punctuation">.</span>Newhope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ISomeDroid<span class="token punctuation">)</span>result<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Hero<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetHeroAsync</span><span class="token punctuation">(</span>Episode<span class="token punctuation">.</span>Empire<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ISomeHuman<span class="token punctuation">)</span>result<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Hero<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Run the console and it will output the following;</p>
<pre><code class="hljs css language-bash">R2-D2
Luke Skywalker
</code></pre>
<p>That is quite awesome. The client is easy to setup and easy to use. We just had to initialize our project and write a GraphQL query document and everything was generated so that we can focus on using our GraphQL endpoint instead of writing a bunch of code that we do not want to actually write. Moreover, we only get the types from the schema that we actually use in our query documents, that means we are not burdened with all the schema types and fields and so on that we do not need and do not want.</p>
<p><em>Strawberry Shake</em> let`s you take all the power of GraphQL and package it up into a fully typed client that works well with .NET. It does not limit you by introducing a new programming model like Linq or some other .NET API, instead <em>Strawberry Shake</em> makes <strong>GraphQL a first class citizen in the .NET world</strong>.</p>
<p>OK, now let us have a look at the result object since we also carefully discussed how we expose results to the consumer.</p>
<p>The result of an operation can be a <code>IOperationResult&lt;T&gt;</code> or a <code>IResponseStream&lt;T&gt;</code>.</p>
<p>The operation result represents a single result and we expose the GraphQL result structure as specified in the GraphQL spec.</p>
<p>This means that we give you a chance to take advantage of partial results in case of errors. However, we also make it easy to raise an exception in case of any error with the <code>EnsureNoErrors</code> method on the result object. This is kind of like with responses from a <code>HttpClient</code>.</p>
<p>Also, we allow you to have full access to provider specific data that is included in a dictionary called <code>Extensions</code>. This for instances is used in cases like active persisted queries or other provider specific extensions.</p>
<h2><a class="anchor" aria-hidden="true" id="renaming-type-elements"></a><a href="#renaming-type-elements" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Renaming Type Elements</h2>
<p>Did you notice the enum type <code>Episode.Newhope</code> in the upper example. This really is not nice to see as a C# developer :). Since the generator is built on top of the stitching API we easily can amend things like that in order to make our client API nice to use.</p>
<p>So, before we go into subscriptions let`s fix that :)</p>
<p>First, add another GraphQL file and call it <code>StarWars.Extensions.graphql</code>. Again, the name does not really matter, you could call it <code>Foo.graphql</code> and <em>Strawberry Shake</em> would also handle it correctly.</p>
<p>GraphQL allows to extend types with the <code>extend</code> keyword in the GraphQL SDL. In the example below we extend the <code>Episode</code> enum and add a directive (annotation) called <code>@name</code>. The <code>@name</code> directive allows us to provide the generator with a name for a type element that we actually want to use in our C# client API.</p>
<p>Now add the following type extension to the GraphQL file <code>StarWars.Extensions.graphql</code>:</p>
<pre><code class="hljs css language-graphql">extend <span class="token keyword">enum</span> <span class="token class-name">Episode</span> <span class="token punctuation">{</span>
  <span class="token constant">NEWHOPE</span> <span class="token directive function">@name</span><span class="token punctuation">(</span><span class="token attr-name">value</span><span class="token punctuation">:</span> <span class="token string">"NewHope"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Rebuild your project and voila ... <code>Episode.NewHope</code> is now correctly cased.</p>
<p>The nice thing is that we are just describing what we want to change in this schema extension file, so every time you update the server schema, we will preserve this file and reapply the type extensions to the newly downloaded schema.</p>
<h2><a class="anchor" aria-hidden="true" id="subscriptions"></a><a href="#subscriptions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subscriptions</h2>
<p>OK, OK, most of this was already in place, so let us have a look at something more challenging like subscriptions.</p>
<p>Subscriptions will need a state-full connection to a server through a WebSocket. There are other ways to do this like SignalR (which essentially is a socket abstraction) or gRPC or even over a standard TCP socket.</p>
<p>While we are in the works to get SignalR and gRPC in let us have a look at how we can do it through WebSockets.</p>
<p>When we started on this we found that WebSockets should be as easy as setting up the HttpClient nowadays. So, we have introduced a new interface called <code>IWebSocketClientFactory</code>. But just having a factory is not enough since we want to maybe pool socket connections and reuse those with multiple subscriptions.</p>
<p>With the solution that we are introducing with version 11.0.0-preview.58 we are making WebSockets super simple to setup, and we will do all the hard parts like reusing the connection and things like that without you ever noticing it.</p>
<p>Let us have a look at how we can get subscriptions to work.</p>
<p>The first thing we have to do is going back to our query document. The <em>Star Wars</em> server has one subscription that is raised whenever a review is written. So, let’s use it and add it to our query file.</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">query</span> getHero<span class="token punctuation">(</span><span class="token variable">$episode</span><span class="token punctuation">:</span> Episode<span class="token operator">!</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hero<span class="token punctuation">(</span><span class="token attr-name">episode</span><span class="token punctuation">:</span> <span class="token variable">$episode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token fragment function">SomeDroid</span>
    <span class="token operator">...</span><span class="token fragment function">SomeHuman</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

subscription onReviewCreated<span class="token punctuation">(</span><span class="token attr-name">episode</span><span class="token punctuation">:</span> <span class="token variable">$episode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onReview<span class="token punctuation">(</span><span class="token attr-name">episode</span><span class="token punctuation">:</span> <span class="token variable">$episode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    commentary
    stars
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">SomeHuman</span> <span class="token keyword">on</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token fragment function">HasName</span>
  homePlanet
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">SomeDroid</span> <span class="token keyword">on</span> <span class="token class-name">Droid</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token fragment function">HasName</span>
  primaryFunction
<span class="token punctuation">}</span>

<span class="token keyword">fragment</span> <span class="token fragment function">HasName</span> <span class="token keyword">on</span> <span class="token class-name">Character</span> <span class="token punctuation">{</span>
  name
<span class="token punctuation">}</span>
</code></pre>
<p>Now, lets rebuild our project and then look at the client interface.</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IStarWarsClient</span>
<span class="token punctuation">{</span>
    Task<span class="token operator">&lt;</span>IOperationResult<span class="token operator">&lt;</span>IGetHero<span class="token operator">>></span> <span class="token function">GetHeroAsync</span><span class="token punctuation">(</span>
        Optional<span class="token operator">&lt;</span>Episode<span class="token operator">></span> episode <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">,</span>
        <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Task<span class="token operator">&lt;</span>IResponseStream<span class="token operator">&lt;</span>IOnReviewCreated<span class="token operator">>></span> <span class="token function">OnReviewCreatedAsync</span><span class="token punctuation">(</span>
        Optional<span class="token operator">&lt;</span>Episode<span class="token operator">></span> episode <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">,</span>
        <span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Our client has now a new method that returns a response stream. A response stream is essentially an <code>IAsyncEnumerable</code> that will loop over the subscription event stream until the stream completes or the client disposes the stream.</p>
<p>Now let us put everything together. First we need to configure the WebSocket client connection.</p>
<pre><code class="hljs css language-csharp">services<span class="token punctuation">.</span><span class="token function">AddWebSocketClient</span><span class="token punctuation">(</span>
    <span class="token string">"StarWarsClient"</span><span class="token punctuation">,</span>
    c <span class="token operator">=></span> c<span class="token punctuation">.</span>Uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"ws://localhost:5000/graphql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This kind of looks exactly the way we would configure an HttpClient and it hides all the complex logic about connecting and pooling WebSocket connections. It also lets you easily intercept the connect process to include authentication logic.</p>
<p>The next thing we need to do to consume data from subscriptions is to read from our event stream.</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> serviceCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceCollection<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span>
            <span class="token string">"StarWarsClient"</span><span class="token punctuation">,</span>
            c <span class="token operator">=></span> c<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"http://localhost:5000/graphql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceCollection<span class="token punctuation">.</span><span class="token function">AddStarWarsClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IServiceProvider</span> services <span class="token operator">=</span> serviceCollection<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IStarWarsClient</span> client <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token punctuation">&lt;</span><span class="token class-name">IStarWarsClient</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">OnReviewCreatedAsync</span><span class="token punctuation">(</span>Episode<span class="token punctuation">.</span>NewHope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> result <span class="token keyword">in</span> stream<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">EnsureNoErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>Data<span class="token operator">!</span><span class="token punctuation">.</span>OnReview<span class="token punctuation">.</span>Commentary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>If you look at the code above it looks so easy how you can use subscription with <em>Strawberry Shake</em>, it almost looks no different from fetching a simple query with the <code>HttpClient</code>. This is exactly what we want the experience to be, simple but when you want to get into the pluming then we will allow you to easily intercept and extend the whole pipeline.</p>
<p>So, in order to try subscriptions out in your example open a tool like playground and the fire the following query against the local GraphQL Server while your console app is running.</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">mutation</span> <span class="token punctuation">{</span>
  createReview<span class="token punctuation">(</span>
    <span class="token attr-name">episode</span><span class="token punctuation">:</span> <span class="token constant">NEWHOPE</span>
    <span class="token attr-name">review</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token attr-name">commentary</span><span class="token punctuation">:</span> <span class="token string">"Awesome movie."</span><span class="token punctuation">,</span> <span class="token attr-name">stars</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    commentary
    stars
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>As soon as you trigger the above mutation the client will print the commentary to the console, it is kind of like magic :)</p>
<h2><a class="anchor" aria-hidden="true" id="custom-scalars"></a><a href="#custom-scalars" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Scalars</h2>
<p>The mean thing with all these examples that I posted in this blog is that I am only using the <em>Star Wars</em> example. The <em>Star Wars</em> uses no custom scalars and is super simple to use. That is the reason why I like to use it for demos, because people get easily on board with it. But it also is frustrating when you want to go deeper. This is especially true with custom scalars.</p>
<p><em>Strawberry Shake</em> supports an array of built-in scalars that go beyond the GraphQL spec. But still if you download the GitHub schema for instance you will get a ton of custom scalars.</p>
<p>With the current version we have made dealing with custom scalars a lot easier. First, if we do not know a scalar, then we will treat it as a <code>String</code>. While this is not always what you want, it lets you get started quickly and then change things when you really need them to change.</p>
<p>Let us have a look at how we can bring in a custom scalar. For this example, let us assume we have a scalar called <code>ByteArray</code>. This scalar serializes a <code>System.Byte[]</code> to a base64 string. This is easy enough. So on the client side we want the generator to generate models that expose <code>System.Byte[]</code> as property type. But in the communication between server and client the type shall be serialized as base64 string.</p>
<p>So, in order to give the generator a hint about these things we need to extend our schema. We would need to create a GraphQL file that holds our schema extensions (basically like with the enum example, where we renamed the enum value). The same way we can extend enums we can extend other types. In this case we want to annotate a scalar type.</p>
<pre><code class="hljs css language-graphql">extend <span class="token keyword">scalar</span> <span class="token class-name">ByteArray</span>
  <span class="token directive function">@runtimeType</span><span class="token punctuation">(</span><span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token string">"System.Byte[]"</span><span class="token punctuation">)</span>
  <span class="token directive function">@serializationType</span><span class="token punctuation">(</span><span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token string">"System.String"</span><span class="token punctuation">)</span>
</code></pre>
<p>The above example declares that for the <code>ByteArray</code> scalar the runtime type (the type that is used in the C# models) shall be a <code>System.Byte[]</code> and that the serialization type (the type which client and server use to send the data) shall be a <code>System.String</code>. For the generator that is enough to generate everything accordingly.</p>
<p>We still have to implement an <code>IValueSerializer</code> to specify the logic how the type shall actually serialize and deserialize.</p>
<pre><code class="hljs css language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteArrayValueSerializer</span>
    <span class="token punctuation">:</span> <span class="token class-name">ValueSerializerBase</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">string</span> Name <span class="token operator">=></span> <span class="token string">"ByteArray"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token class-name">ValueKind</span> Kind <span class="token operator">=></span> ValueKind<span class="token punctuation">.</span>String<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">object</span><span class="token punctuation">?</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">?</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">is</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token keyword">is</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">(</span>
            <span class="token string">"The specified value is of an invalid type. "</span> <span class="token operator">+</span>
            $<span class="token string">"{ClrType.FullName} was expeceted."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">object</span><span class="token punctuation">?</span> <span class="token function">Deserialize</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">?</span> serialized<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serialized <span class="token keyword">is</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>serialized <span class="token keyword">is</span> <span class="token keyword">string</span> s<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Convert<span class="token punctuation">.</span><span class="token function">FromBase64String</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">(</span>
            <span class="token string">"The specified value is of an invalid type. "</span> <span class="token operator">+</span>
            $<span class="token string">"{SerializationType.FullName} was expeceted."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The serializer can be added as a singleton and will be automatically integrated by the generated client.</p>
<pre><code class="hljs css language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">IValueSerializer</span><span class="token punctuation">,</span> <span class="token class-name">ByteArrayValueSerializer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<blockquote>
<p>We are refining how those serializers are registered. This is important for cases where one wants to have multiple clients with different kinds of serializers. I know this is rare but still this should work. The coming versions of <em>Strawberry Shake</em> will fine tune this.</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="digging-deeper"></a><a href="#digging-deeper" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Digging Deeper</h2>
<p>Apart from being able to add custom scalars we might want to dig deeper and allow new scenarios with our client like persisted queries. It is needles to say that we will add persisted query support out of the box. But it is also a good example to use to show how we can enable advance server / client protocols with <em>Strawberry Shake</em>.</p>
<p>The way we built-in things like that is by providing a operation middleware. This basically works like the query middleware in the server on the request level.</p>
<p><em>Strawberry Shake</em> allows us to swap out the default operation execution pipeline and add our own custom operation execution pipeline.</p>
<p>In order to setup a custom operation execution pipeline you can use for instance the <code>HttpPipelineBuilder</code>. Each transport has it`s own transport specific pipeline since the protocol between socket communication and stateless communication is quite different.</p>
<pre><code class="hljs css language-csharp">serviceCollection<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">OperationDelegate</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
    sp <span class="token operator">=></span> HttpPipelineBuilder<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Use</span><span class="token punctuation">&lt;</span><span class="token class-name">CreateStandardRequestMiddleware</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Use</span><span class="token punctuation">&lt;</span><span class="token class-name">CustomMiddleware</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Use</span><span class="token punctuation">&lt;</span><span class="token class-name">SendHttpRequestMiddleware</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Use</span><span class="token punctuation">&lt;</span><span class="token class-name">ParseSingleResultMiddleware</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre><code class="hljs css language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMiddleware</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">OperationDelegate</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IOperationSerializer</span> _service<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CustomMiddleware</span><span class="token punctuation">(</span>
        <span class="token class-name">OperationDelegate</span> next<span class="token punctuation">,</span>
        <span class="token class-name">ISomeCustomService</span> service<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _next <span class="token operator">=</span> next <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _service <span class="token operator">=</span> service <span class="token operator">??</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span><span class="token class-name">IHttpOperationContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// the custom middleware code</span>
        <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="generation-options"></a><a href="#generation-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Generation Options</h2>
<p>By default <em>Strawberry Shake</em> generates dependency injection code for <code>Microsoft.Extensions.DependencyInjection</code> this can be switched of by adding the following <code>MSBuild</code> property <code>&lt;GraphQLEnableDI&gt;false&lt;/GraphQLEnableDI&gt;</code>.</p>
<p>The generator will automatically detect if you are using C# 8.0 with nullable reference types or if you are using an older version of C#.</p>
<p>You can use the following <code>MSBuild</code> properties to control this.</p>
<pre><code class="hljs css language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LangVersion</span><span class="token punctuation">></span></span>8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LangVersion</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Nullable</span><span class="token punctuation">></span></span>enable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Nullable</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">></span></span>
</code></pre>
<p>We also by default take the root namespace from the project for generating files. You can however override this by providing the <code>&lt;BerryNamespace /&gt;</code> property. However, we will change this to an item group soon in order to also enable multiple clients in a single project to use different namespaces.</p>
<pre><code class="hljs css language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BerryNamespace</span><span class="token punctuation">></span></span>$(RootNamespace)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>BerryNamespace</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">></span></span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="dependency-injection"></a><a href="#dependency-injection" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dependency Injection</h2>
<p>The client API can be used with other dependency injection container and also without dependency injection at all.</p>
<p>We initially had a limited builder API for this but decided to give it a do over. So, at the moment you could look at the generated dependency injection code and build your own integration.</p>
<p>We will allow with future build to add custom generators that can provide additional code for custom use cases. The way that would work is that such a generator would sit in a NuGet package that is being added to the project. The custom generator would register its generators to an item group and <em>Strawberry Shake</em> would pick those up and integrate them. These custom generators however are somewhere in the version 12 timeframe.</p>
<h2><a class="anchor" aria-hidden="true" id="roadmap"></a><a href="#roadmap" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Roadmap</h2>
<p>What are our next steps on <em>Strawberry Shake</em> and when are we planning to release it?</p>
<p>We have some more ground to cover before we have this version complete.</p>
<ol>
<li><p>MSBuild Integration
We are working on making the <em>MSBuild</em> integration better. There are still instances with <em>VSCode</em> where you have to compile twice. This is OK for a preview,but we are on it and think that in the next view preview builds we will have this fixed. With <em>Visual Studio for Windows</em> you can already enjoy design time code generation. This means that when you save a GraphQL file the generator will update the C# files.</p></li>
<li><p>Tooling
We are heavy at work on <em>Bananacake Pop</em> which is our GraphQL IDE that will help you write and analyze GraphQL queries.
We plan to use what we have done for <em>Bananacake Pop</em> to create a nice integration with <em>VSCode</em>. We want to have a rich integration with which you can work on huge schemas.</p>
<p>Beyond <em>VSCode</em> we are looking at writing a nice integration with <em>Visual Studio for Windows</em> and <em>Visual Studio for macOS</em> that will make <em>Strawberry Shake</em> and <em>GraphQL</em> a first-class citizen in Microsoft IDEs.</p>
<p>We hope to deliver all of this in the version 11 timeframe.</p></li>
<li><p>Persisted Query Support
Persisted queries are one of our very next features that we will add to the client. We want to allow the same flows that we support on the server side.</p></li>
<li><p>Batching Support
Batching support with the <code>@export</code> directive is as well planned for the initial release of <em>Strawberry Shake</em>.</p></li>
<li><p>Code Generation
The current code generation produces quite nice code, but it can produce issues where the types from your own project collide with the generated code. With the next view builds we will add an option to use full type names in those cases.
Also, we will add the code generation attribute to the generated files. So there are refinements going on in this area.</p></li>
<li><p>Defer / Stream
We are planning to add support for defer and stream to the client. This feature depends on our server implementation so we will have to see how far we are on execution plans before we can start on it for the client.</p></li>
</ol>
<p>I hope you enjoy what we are building. We are tying to bring GraphQL on .NET to the next level. While we still are miles away from what the JavaScript world has to offer we hope to close these gaps over the next year and even pull ahead in some areas. We love GraphQL and are passionate about it. We strongly believe that with our newest member <em>Strawberry Shake</em> we really can make things like <em>Xamarin</em> and <em>Blazor</em> so much better. We have planned a lot more and hope to bring data fetching in .NET to a whole new level over the next year. Ideally you just want to decalre in your .NET component the data that you need and all the client logic is infered from that, kind of the way relay works in JavaScript.</p>
<p>If you want to get into contact with us head over to our <a href="https://join.slack.com/t/hotchocolategraphql/shared_invite/enQtNTA4NjA0ODYwOTQ0LTViMzA2MTM4OWYwYjIxYzViYmM0YmZhYjdiNzBjOTg2ZmU1YmMwNDZiYjUyZWZlMzNiMTk1OWUxNWZhMzQwY2Q">slack channel</a> and join our community.</p>
<table>
<thead>
<tr><th><a href="https://join.slack.com/t/hotchocolategraphql/shared_invite/enQtNTA4NjA0ODYwOTQ0LTViMzA2MTM4OWYwYjIxYzViYmM0YmZhYjdiNzBjOTg2ZmU1YmMwNDZiYjUyZWZlMzNiMTk1OWUxNWZhMzQwY2Q">HotChocolate Slack Channel</a></th><th><a href="https://hotchocolate.io">Hot Chocolate Documentation</a></th><th><a href="https://github.com/ChilliCream/hotchocolate">Hot Chocolate on GitHub</a></th></tr>
</thead>
<tbody>
</tbody>
</table>
</span></div></div><div class="blogSocialSection"><div class="blogSocialSectionItem"><a href="https://twitter.com/share" class="twitter-share-button" data-text="Building a real-time .NET GraphQL Client API" data-url="https://chillicream.com/blog/2019/11/25/strawberry-shake_2" data-related="true" data-show-count="false">Tweet</a></div></div></div><div class="blog-recent"><a class="button" href="/blog">Recent posts</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#getting-started">Getting Started</a></li><li><a href="#renaming-type-elements">Renaming Type Elements</a></li><li><a href="#subscriptions">Subscriptions</a></li><li><a href="#custom-scalars">Custom Scalars</a></li><li><a href="#digging-deeper">Digging Deeper</a></li><li><a href="#generation-options">Generation Options</a></li><li><a href="#dependency-injection">Dependency Injection</a></li><li><a href="#roadmap">Roadmap</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/signet.png" alt="ChilliCream" width="64" height="64"/></a><div><h5>Projects</h5><a href="https://greendonut.io" target="_blank">Green Donut</a><a href="https://hotchocolate.io" target="_blank">Hot Chocolate</a><a href="https://react-rasta.com" target="_blank">React Rasta</a><a href="https://github.com/ChilliCream/thor-core" target="_blank">Thor</a></div><div><h5>Community</h5><a href="https://twitter.com/Chilli_Cream" target="_blank" rel="noreferrer noopener">Follow us on Twitter</a></div><div><h5>More</h5><a href="/blog">Blog</a><a href="https://shop.chillicream.com" target="_blank">Shop</a><a href="https://github.com/ChilliCream/website" target="_blank">GitHub</a><a href="https://github.com/ChilliCream/website/issues" target="_blank">Issues</a><a class="github-button" href="https://github.com/ChilliCream/website" data-icon="octicon-star" data-count-href="/chillicream/website/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2020 ChilliCream</section></footer></div><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>