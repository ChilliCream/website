<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>GraphQL .NET Instrumentation API and Apollo Tracing · ChilliCream</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Today we have released [Hot Chocolate] `0.7.0`, containing one cool new feature,"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="GraphQL .NET Instrumentation API and Apollo Tracing · ChilliCream"/><meta property="og:type" content="website"/><meta property="og:url" content="https://chillicream.com/blog/2019/02/04/instrumentation-and-apollo-tracing"/><meta property="og:description" content="Today we have released [Hot Chocolate] `0.7.0`, containing one cool new feature,"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://chillicream.com/img/signet.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css"/><link rel="alternate" type="application/atom+xml" href="https://chillicream.com/blog/atom.xml" title="ChilliCream Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://chillicream.com/blog/feed.xml" title="ChilliCream Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-72800164-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:700,400"/><link rel="stylesheet" href="/css/code-block-buttons.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/google-adsense.js"></script><script type="text/javascript" src="/js/disqus.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/signet.png" alt="ChilliCream"/><h2 class="headerTitleWithLogo">ChilliCream</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/blog/" target="_self">Blog</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>All blog posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">All blog posts</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/blog/2019/02/04/instrumentation-and-apollo-tracing">GraphQL .NET Instrumentation API and Apollo Tracing</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/02/04/hot-chocolate-0.7.0">GraphQL - Hot Chocolate 0.7.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/01/24/schema-stitching">GraphQL - Schema Stitching</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/11/07/docusaurus-docs-redirect">Docusaurus - How to redirect requests to /docs to a default url instead of getting a 404 error</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/09/02/hot-chocolate-0.4.5">GraphQL - Hot Chocolate 0.4.5</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/07/31/hot-chocolate-0.4.0">GraphQL - Hot Chocolate 0.4.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/07/30/green-donut-0.2.0">Green Donut 0.2.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2018/05/03/react-rasta-1.0.0">React Rasta 1.0.0</a></li><li class="navListItem"><a class="navItem" href="/blog/2013/09/12/jquery-steps-form-wizard">How to create a Form Wizard using jQuery Steps</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog/2019/02/04/instrumentation-and-apollo-tracing">GraphQL .NET Instrumentation API and Apollo Tracing</a></h1><p class="post-meta">February 4, 2019</p><div class="authorBlock"><p class="post-authorName"><a href="https://github.com/rstaib" target="_blank" rel="noreferrer noopener">Rafael Staib</a></p><div class="authorPhoto"><a href="https://github.com/rstaib" target="_blank" rel="noreferrer noopener"><img src="https://avatars0.githubusercontent.com/u/4325318?s=100&amp;v=4" alt="Rafael Staib"/></a></div></div></header><div><span><p>Today we have released <a href="https://hotchocolate.io">Hot Chocolate</a> <code>0.7.0</code>, containing one cool new feature,
we wanne talk about here, namely <em>Apollo Tracing</em> which is extremely powerful in
identifing things like performance bottlenecks in our <em>GraphQL</em> <em>APIs</em> for
example. As a result, we had to enhance our general instrumentation layer, which
we all benefit from. For instance, now it's way easier to register a
<em>DiagnosticObserver</em> and bring in your own tracing framework, respectively. In
this blog article we will focus on these two topics.</p>
<!--truncate-->
<h2><a class="anchor" aria-hidden="true" id="apollo-tracing"></a><a href="#apollo-tracing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Apollo Tracing</h2>
<p><em>Apollo Tracing</em> is a <a href="https://github.com/apollographql/apollo-tracing">performance tracing specification</a> for <em>GraphQL</em> servers.
It's not part of the actual <em>GraphQL</em> <a href="https://facebook.github.io/graphql">specification</a> itself, but there is a
common aggrement in the <em>GraphQL</em> community that this should be supported by
all <em>GraphQL</em> servers.</p>
<p>So, we decided to introduce built-in <em>Apollo Tracing</em> support with this version.
In order to enable <em>Apollo Tracing</em> we just need to provide our own instance of
<code>QueryExecutionOptions</code> to the <code>AddGraphQL</code> extension method and set the
<code>TracingPreference</code> option to either <code>TracingPreference.Always</code> or
<code>TracingPreference.OnDemand</code>. The difference between these two options is
whether tracing should be enabled always which means for each request or on
demand which means per request. But for now, enough words, let's see how this
would look like in code.</p>
<pre><code class="hljs css language-csharp">services.AddGraphQL(sp =&gt; Schema.Create(c =&gt;
{
    <span class="hljs-comment">// Here goes the schema definition which is omitted for brevity purpose</span>
}),
<span class="hljs-keyword">new</span> QueryExecutionOptions
{
    TracingPreference = TracingPreference.Always
});
</code></pre>
<p>There it is. Very simple and straightforward, right? Let's jump over to the next
topic.</p>
<h2><a class="anchor" aria-hidden="true" id="instrumentation-api"></a><a href="#instrumentation-api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Instrumentation API</h2>
<p>In this version we did some heavy lifting in form of refactorings regarding the
query execution pipeline. This really helped us enhancing the
<em>Instrumentation</em> <em>API</em> which has been evolved in two ways. First, we increased
the amount of available diagnostic events for more fine-grained tracing
scenarios. Second, we simplified the registering of <em>DiagnosticObservers</em> by
using <em>Dependancy Injection</em> infrastructure. In the next example we can see how
to register a custom <em>DiagnosticObservers</em>.</p>
<pre><code class="hljs css language-csharp">services.AddGraphQL(sp =&gt; Schema.Create(c =&gt;
{
    <span class="hljs-comment">// Here goes the schema definition which is omitted for brevity purpose</span>
}),
builder =&gt;
{
    <span class="hljs-keyword">return</span> builder
        .UseDefaultPipeline()
        .AddDiagnosticObserver&lt;CustomObserver&gt;();
});
</code></pre>
<p>So far so good. Writing a custom <em>DiagnosticObservers</em> is not difficult. Let's
see how we could achieve this.</p>
<pre><code class="hljs css language-csharp"><span class="hljs-keyword">using</span> HotChocolate.Execution;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DiagnosticAdapter;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">CustomNamespace</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ApolloTracingDiagnosticObserver</span>
        : <span class="hljs-title">IDiagnosticObserver</span>
    {
        [<span class="hljs-meta">DiagnosticName(<span class="hljs-meta-string">"HotChocolate.Execution.Query"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">QueryExecute</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-comment">// This method is required to enable recording "Query.Start" and</span>
            <span class="hljs-comment">// "Query.Stop" diagnostic events. Do not write code in here.</span>
        }

        [<span class="hljs-meta">DiagnosticName(<span class="hljs-meta-string">"HotChocolate.Execution.Query.Start"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">BeginQueryExecute</span>(<span class="hljs-params">IQueryContext context</span>)</span>
        {
            <span class="hljs-comment">// Here goes your code to trace begin query execution events.</span>
        }

        [<span class="hljs-meta">DiagnosticName(<span class="hljs-meta-string">"HotChocolate.Execution.Query.Stop"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">EndQueryExecute</span>(<span class="hljs-params">
            IQueryContext context,
            IExecutionResult result</span>)</span>
        {
            <span class="hljs-comment">// Here goes your code to trace end query execution events.</span>
        }
    }
}
</code></pre>
<p>In the above example we showed you just a few diagnostic events. Head over
<a href="https://hotchocolate.io/docs/diagnostics">here</a> for a complete list of
diagnostic events.</p>
<p>We hope you enjoyed reading and be welcome to let us know what you think about
it in the comments section. Thank you!</p>
<table>
<thead>
<tr><th><a href="https://hotchocolate.io">Hot Chocolate Documentation</a></th><th><a href="https://github.com/ChilliCream/hotchocolate">Hot Chocolate on GitHub</a></th></tr>
</thead>
<tbody>
</tbody>
</table>
</span></div></div><div class="blogSocialSection"><div class="blogSocialSectionItem"><a href="https://twitter.com/share" class="twitter-share-button" data-text="GraphQL .NET Instrumentation API and Apollo Tracing" data-url="https://chillicream.com/blog/2019/02/04/instrumentation-and-apollo-tracing" data-related="true" data-show-count="false">Tweet</a></div></div></div><div class="blog-recent"><a class="button" href="/blog">Recent posts</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#apollo-tracing">Apollo Tracing</a></li><li><a href="#instrumentation-api">Instrumentation API</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/signet.png" alt="ChilliCream" width="64" height="64"/></a><div><h5>Projects</h5><a href="https://greendonut.io" target="_blank">Green Donut</a><a href="https://hotchocolate.io" target="_blank">Hot Chocolate</a><a href="https://react-rasta.com" target="_blank">React Rasta</a><a href="https://github.com/ChilliCream/thor-core" target="_blank">Thor</a></div><div><h5>Community</h5><a href="https://twitter.com/Chilli_Cream" target="_blank" rel="noreferrer noopener">Follow us on Twitter</a></div><div><h5>More</h5><a href="/blog">Blog</a><a href="https://github.com/ChilliCream/website" target="_blank">GitHub</a><a href="https://github.com/ChilliCream/website/issues" target="_blank">Issues</a><a class="github-button" href="https://github.com/ChilliCream/website" data-icon="octicon-star" data-count-href="/chillicream/website/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2019 ChilliCream</section></footer></div><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>